<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InkFlow Studio | Advanced Digital Art Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #6c5ce7;
            --primary-dark: #5649c0;
            --secondary: #fd79a8;
            --dark: #2d3436;
            --darker: #1e272e;
            --light: #f5f6fa;
            --gray: #a4b0be;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #e84393;
        }

        body {
            background-color: var(--darker);
            color: var(--light);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background-color: var(--dark);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            color: var(--primary);
            font-size: 1.8rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-links {
            display: flex;
            gap: 5px;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--gray);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn.active, .nav-btn:hover {
            background-color: rgba(108, 92, 231, 0.2);
            color: var(--primary);
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #e84393;
        }

        .btn-outline {
            background: none;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: rgba(108, 92, 231, 0.1);
        }

        /* Main Content */
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background-color: var(--dark);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            overflow-y: auto;
        }

        .tool-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .tool-group h3 {
            font-size: 1rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-group h3 i {
            color: var(--primary);
        }

        .color-picker {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #color-picker {
            width: 100%;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .preset-colors {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .preset-color {
            aspect-ratio: 1;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid transparent;
        }

        .preset-color.active, .preset-color:hover {
            transform: scale(1.1);
            border-color: white;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider-container i {
            color: var(--primary);
            width: 20px;
        }

        .slider-container input {
            flex: 1;
        }

        .slider-value {
            min-width: 40px;
            text-align: right;
            font-size: 0.9rem;
        }

        .brush-types {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }

        .brush-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 5px;
            background-color: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 8px;
            color: var(--light);
            cursor: pointer;
            transition: all 0.2s;
        }

        .brush-btn.active, .brush-btn:hover {
            background-color: var(--primary);
            transform: translateY(-2px);
        }

        .brush-icon {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .brush-name {
            font-size: 0.7rem;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .controls .btn {
            flex: 1;
            justify-content: center;
            font-size: 0.8rem;
            padding: 8px 5px;
        }

        .hotkey-hint {
            font-size: 0.7rem;
            color: var(--gray);
            margin-top: 10px;
            text-align: center;
        }

        /* Canvas Area */
        .canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
        }

        .canvas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .canvas-container {
            flex: 1;
            background-color: var(--dark);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #drawing-canvas {
            background-color: white;
            cursor: crosshair;
            display: block;
        }

        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            display: none;
        }

        .zoom-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: rgba(45, 52, 54, 0.8);
            border-radius: 8px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary);
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: white;
            border: none;
        }

        .zoom-btn:hover {
            background-color: var(--primary-dark);
        }

        .zoom-display {
            font-size: 0.8rem;
            font-weight: bold;
        }

        .canvas-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .canvas-info {
            display: flex;
            gap: 15px;
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* Layers Panel */
        .layers-panel {
            background-color: var(--dark);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .layer-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .layer-item.active {
            background-color: rgba(108, 92, 231, 0.3);
        }

        .layer-visibility {
            margin-right: 10px;
            cursor: pointer;
        }

        .layer-name {
            flex: 1;
            font-size: 0.9rem;
        }

        .layer-actions {
            display: flex;
            gap: 5px;
        }

        .layer-btn {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .layer-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--dark);
            border-radius: 10px;
            padding: 25px;
            width: 450px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: var(--light);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: var(--light);
            font-size: 1rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--success);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: fadeIn 0.3s ease-out;
            display: none;
        }

        .notification.error {
            background-color: var(--danger);
        }

        .notification.warning {
            background-color: var(--warning);
            color: var(--dark);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Advanced Tools Panel */
        .advanced-tools {
            background-color: var(--dark);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .tool-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .tool-option:last-child {
            margin-bottom: 0;
        }

        .tool-label {
            font-size: 0.9rem;
        }

        .tool-select {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: var(--light);
            padding: 5px;
            font-size: 0.8rem;
        }

        /* Color History */
        .color-history {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .history-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            
            .nav-links {
                display: none;
            }
            
            .logo h1 {
                font-size: 1.2rem;
            }
            
            .brush-types {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="logo">
            <i class="fas fa-paint-brush"></i>
            <h1>InkFlow Studio</h1>
        </div>
        <div class="nav-links">
            <button class="nav-btn active"><i class="fas fa-draw-polygon"></i> Canvas</button>
            <button class="nav-btn"><i class="fas fa-palette"></i> Gallery</button>
            <button class="nav-btn"><i class="fas fa-cog"></i> Settings</button>
        </div>
        <div class="user-actions">
            <button class="btn btn-outline" id="login-btn">Login</button>
            <button class="btn btn-primary" id="register-btn">Sign Up</button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="tool-group">
                <h3><i class="fas fa-fill-drip"></i> Color</h3>
                <div class="color-picker">
                    <input type="color" id="color-picker" value="#6c5ce7">
                    <div class="preset-colors">
                        <div class="preset-color active" style="background-color: #ff6b6b;" data-color="#ff6b6b"></div>
                        <div class="preset-color" style="background-color: #4fc3f7;" data-color="#4fc3f7"></div>
                        <div class="preset-color" style="background-color: #8a2be2;" data-color="#8a2be2"></div>
                        <div class="preset-color" style="background-color: #ffd166;" data-color="#ffd166"></div>
                        <div class="preset-color" style="background-color: #06d6a0;" data-color="#06d6a0"></div>
                        <div class="preset-color" style="background-color: #ff9e6d;" data-color="#ff9e6d"></div>
                    </div>
                </div>
                <div class="slider-container">
                    <i class="fas fa-adjust"></i>
                    <input type="range" id="brush-opacity" min="1" max="100" value="100">
                    <span class="slider-value" id="opacity-value">100%</span>
                </div>
                <div class="color-history" id="color-history">
                    <!-- Color history will be populated here -->
                </div>
            </div>

            <div class="tool-group">
                <h3><i class="fas fa-sliders-h"></i> Brush</h3>
                <div class="slider-container">
                    <i class="fas fa-ruler-combined"></i>
                    <input type="range" id="brush-size" min="1" max="40" value="10">
                    <span class="slider-value" id="brush-size-value">10px</span>
                </div>
                <div class="slider-container">
                    <i class="fas fa-tachometer-alt"></i>
                    <input type="range" id="brush-flow" min="1" max="100" value="100">
                    <span class="slider-value" id="brush-flow-value">100%</span>
                </div>
                <div class="slider-container">
                    <i class="fas fa-feather"></i>
                    <input type="range" id="brush-hardness" min="1" max="100" value="100">
                    <span class="slider-value" id="brush-hardness-value">100%</span>
                </div>
            </div>

            <div class="tool-group">
                <h3><i class="fas fa-paint-brush"></i> Brushes</h3>
                <div class="brush-types">
                    <button class="brush-btn active" id="brush-normal" data-type="normal">
                        <div class="brush-icon"><i class="fas fa-paint-brush"></i></div>
                        <div class="brush-name">Normal</div>
                    </button>
                    <button class="brush-btn" id="brush-pixel" data-type="pixel">
                        <div class="brush-icon"><i class="fas fa-th-large"></i></div>
                        <div class="brush-name">Pixel</div>
                    </button>
                    <button class="brush-btn" id="brush-rainbow" data-type="rainbow">
                        <div class="brush-icon"><i class="fas fa-rainbow"></i></div>
                        <div class="brush-name">Rainbow</div>
                    </button>
                    <button class="brush-btn" id="brush-fur" data-type="fur">
                        <div class="brush-icon"><i class="fas fa-paw"></i></div>
                        <div class="brush-name">Fur</div>
                    </button>
                    <button class="brush-btn" id="brush-neon" data-type="neon">
                        <div class="brush-icon"><i class="fas fa-lightbulb"></i></div>
                        <div class="brush-name">Neon</div>
                    </button>
                    <button class="brush-btn" id="brush-shading" data-type="shading">
                        <div class="brush-icon"><i class="fas fa-cloud"></i></div>
                        <div class="brush-name">Shading</div>
                    </button>
                    <button class="brush-btn" id="brush-spray" data-type="spray">
                        <div class="brush-icon"><i class="fas fa-spray-can"></i></div>
                        <div class="brush-name">Spray</div>
                    </button>
                    <button class="brush-btn" id="brush-eraser" data-type="eraser">
                        <div class="brush-icon"><i class="fas fa-eraser"></i></div>
                        <div class="brush-name">Erase</div>
                    </button>
                    <button class="brush-btn" id="brush-calligraphy" data-type="calligraphy">
                        <div class="brush-icon"><i class="fas fa-pen-nib"></i></div>
                        <div class="brush-name">Calligraphy</div>
                    </button>
                    <button class="brush-btn" id="brush-glitter" data-type="glitter">
                        <div class="brush-icon"><i class="fas fa-sparkles"></i></div>
                        <div class="brush-name">Glitter</div>
                    </button>
                    <button class="brush-btn" id="brush-watercolor" data-type="watercolor">
                        <div class="brush-icon"><i class="fas fa-tint"></i></div>
                        <div class="brush-name">Watercolor</div>
                    </button>
                    <button class="brush-btn" id="brush-oil" data-type="oil">
                        <div class="brush-icon"><i class="fas fa-paint-roller"></i></div>
                        <div class="brush-name">Oil</div>
                    </button>
                </div>
            </div>

            <div class="tool-group">
                <h3><i class="fas fa-sliders-h"></i> Controls</h3>
                <div class="controls">
                    <button class="btn btn-outline" id="clear-btn"><i class="fas fa-broom"></i> Clear</button>
                    <button class="btn btn-outline" id="undo-btn"><i class="fas fa-undo"></i> Undo</button>
                    <button class="btn btn-outline" id="redo-btn"><i class="fas fa-redo"></i> Redo</button>
                </div>
                <div class="hotkey-hint">Undo: Ctrl+Z | Clear: Ctrl+Del | Save: Ctrl+S</div>
            </div>

            <div class="tool-group">
                <h3><i class="fas fa-cloud-upload-alt"></i> Export</h3>
                <div class="controls">
                    <button class="btn btn-primary" id="save-btn"><i class="fas fa-save"></i> Save</button>
                    <button class="btn btn-secondary" id="download-btn"><i class="fas fa-download"></i> Export</button>
                    <button class="btn btn-outline" id="print-btn"><i class="fas fa-print"></i> Print</button>
                </div>
            </div>

            <div class="tool-group">
                <h3><i class="fas fa-layer-group"></i> Layers</h3>
                <div class="layers-panel" id="layers-panel">
                    <!-- Layers will be added here dynamically -->
                </div>
                <div class="controls">
                    <button class="btn btn-outline" id="add-layer-btn"><i class="fas fa-plus"></i> Add Layer</button>
                    <button class="btn btn-outline" id="delete-layer-btn"><i class="fas fa-trash"></i> Delete</button>
                    <button class="btn btn-outline" id="merge-layers-btn"><i class="fas fa-object-group"></i> Merge</button>
                </div>
            </div>

            <div class="tool-group">
                <h3><i class="fas fa-cog"></i> Canvas</h3>
                <div class="controls">
                    <button class="btn btn-outline" id="new-project-btn"><i class="fas fa-plus"></i> New Project</button>
                    <button class="btn btn-outline" id="grid-toggle"><i class="fas fa-th"></i> Grid</button>
                    <button class="btn btn-outline" id="ruler-toggle"><i class="fas fa-ruler"></i> Ruler</button>
                </div>
            </div>

            <div class="tool-group">
                <h3><i class="fas fa-magic"></i> Advanced Tools</h3>
                <div class="advanced-tools">
                    <div class="tool-option">
                        <span class="tool-label">Symmetry</span>
                        <select id="symmetry-mode" class="tool-select">
                            <option value="none">None</option>
                            <option value="vertical">Vertical</option>
                            <option value="horizontal">Horizontal</option>
                            <option value="radial">Radial</option>
                        </select>
                    </div>
                    <div class="tool-option">
                        <span class="tool-label">Blending Mode</span>
                        <select id="blend-mode" class="tool-select">
                            <option value="source-over">Normal</option>
                            <option value="multiply">Multiply</option>
                            <option value="screen">Screen</option>
                            <option value="overlay">Overlay</option>
                            <option value="darken">Darken</option>
                            <option value="lighten">Lighten</option>
                            <option value="color-dodge">Color Dodge</option>
                            <option value="color-burn">Color Burn</option>
                        </select>
                    </div>
                    <div class="tool-option">
                        <span class="tool-label">Pressure Sensitivity</span>
                        <input type="checkbox" id="pressure-toggle" checked>
                    </div>
                    <div class="tool-option">
                        <span class="tool-label">Smoothing</span>
                        <input type="range" id="smoothing-level" min="0" max="10" value="5">
                    </div>
                </div>
            </div>

            <div class="tool-group">
                <h3><i class="fas fa-eye-dropper"></i> Color Picker</h3>
                <div class="controls">
                    <button class="btn btn-outline" id="eyedropper-btn"><i class="fas fa-eye-dropper"></i> Pick Color</button>
                </div>
            </div>
        </div>

        <!-- Canvas Area -->
        <div class="canvas-area">
            <div class="canvas-header">
                <h2 id="project-title">Untitled Project</h2>
                <div class="canvas-actions">
                    <button class="btn btn-outline" id="project-settings-btn"><i class="fas fa-cog"></i> Project Settings</button>
                    <button class="btn btn-outline" id="reference-image-btn"><i class="fas fa-image"></i> Reference</button>
                </div>
            </div>
            <div class="canvas-container">
                <canvas id="drawing-canvas" width="800" height="600"></canvas>
                <canvas id="grid-overlay" class="grid-overlay" width="800" height="600"></canvas>
                <canvas id="ruler-overlay" class="grid-overlay" width="800" height="600"></canvas>
                <div class="zoom-controls">
                    <div class="zoom-btn" id="zoom-in"><i class="fas fa-plus"></i></div>
                    <div class="zoom-display" id="zoom-display">100%</div>
                    <div class="zoom-btn" id="zoom-out"><i class="fas fa-minus"></i></div>
                    <div class="zoom-btn" id="reset-view"><i class="fas fa-sync"></i></div>
                </div>
            </div>
            <div class="canvas-nav">
                <div class="canvas-info">
                    <span>Brush: <span id="current-brush">Normal</span></span>
                    <span>Size: <span id="current-size">10px</span></span>
                    <span>Color: <span id="current-color">#6c5ce7</span></span>
                    <span>Layer: <span id="current-layer">Layer 1</span></span>
                </div>
                <div class="canvas-actions">
                    <button class="btn btn-outline" id="toggle-grid-btn"><i class="fas fa-th"></i> Toggle Grid</button>
                    <button class="btn btn-outline" id="fullscreen-btn"><i class="fas fa-expand"></i> Fullscreen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- All modals from previous implementation remain -->
    <!-- Download Modal -->
    <div class="modal" id="download-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-download"></i> Export Artwork</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="filename">File Name</label>
                    <input type="text" id="filename" class="form-control" value="inkflow-artwork">
                </div>
                <div class="form-group">
                    <label for="file-format">Format</label>
                    <select id="file-format" class="form-control">
                        <option value="png">PNG (Recommended)</option>
                        <option value="jpg">JPG</option>
                        <option value="webp">WebP</option>
                        <option value="svg">SVG</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="export-quality">Quality</label>
                    <select id="export-quality" class="form-control">
                        <option value="1">High (100%)</option>
                        <option value="0.9">Medium (90%)</option>
                        <option value="0.7">Low (70%)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="export-scale">Scale</label>
                    <select id="export-scale" class="form-control">
                        <option value="1">100% (Original)</option>
                        <option value="2">200%</option>
                        <option value="0.5">50%</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-download">Cancel</button>
                <button class="btn btn-primary" id="confirm-download">Download</button>
            </div>
        </div>
    </div>

    <!-- Save Modal -->
    <div class="modal" id="save-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-save"></i> Save Project</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="project-name">Project Name</label>
                    <input type="text" id="project-name" class="form-control" value="Untitled Project">
                </div>
                <div class="form-group">
                    <label for="project-description">Description (Optional)</label>
                    <textarea id="project-description" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="project-tags">Tags</label>
                    <input type="text" id="project-tags" class="form-control" placeholder="art, digital, painting">
                </div>
                <div class="form-group">
                    <label for="project-visibility">Visibility</label>
                    <select id="project-visibility" class="form-control">
                        <option value="public">Public</option>
                        <option value="private">Private</option>
                        <option value="unlisted">Unlisted</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-save">Cancel</button>
                <button class="btn btn-primary" id="confirm-save">Save Project</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-sign-in-alt"></i> Welcome to InkFlow</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" class="form-control" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" class="form-control" placeholder="Enter your password">
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <a href="#" style="color: var(--primary); text-decoration: none;">Forgot password?</a>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-login">Cancel</button>
                <button class="btn btn-primary" id="confirm-login">Sign In</button>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal" id="register-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Create Account</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="register-username">Username</label>
                    <input type="text" id="register-username" class="form-control" placeholder="Choose a username">
                </div>
                <div class="form-group">
                    <label for="register-email">Email</label>
                    <input type="email" id="register-email" class="form-control" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="register-password">Password</label>
                    <input type="password" id="register-password" class="form-control" placeholder="Create a password">
                </div>
                <div class="form-group">
                    <label for="register-confirm">Confirm Password</label>
                    <input type="password" id="register-confirm" class="form-control" placeholder="Confirm your password">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-register">Cancel</button>
                <button class="btn btn-primary" id="confirm-register">Create Account</button>
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div class="modal" id="new-project-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-plus"></i> New Project</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-project-name">Project Name</label>
                    <input type="text" id="new-project-name" class="form-control" value="New Project">
                </div>
                <div class="form-group">
                    <label for="canvas-width">Canvas Width</label>
                    <input type="number" id="canvas-width" class="form-control" value="800" min="100" max="4000">
                </div>
                <div class="form-group">
                    <label for="canvas-height">Canvas Height</label>
                    <input type="number" id="canvas-height" class="form-control" value="600" min="100" max="4000">
                </div>
                <div class="form-group">
                    <label for="canvas-background">Background Color</label>
                    <input type="color" id="canvas-background" class="form-control" value="#ffffff">
                </div>
                <div class="form-group">
                    <label for="canvas-dpi">DPI (Resolution)</label>
                    <select id="canvas-dpi" class="form-control">
                        <option value="72">72 DPI (Web)</option>
                        <option value="150">150 DPI (Print)</option>
                        <option value="300" selected>300 DPI (High Quality)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-new-project">Cancel</button>
                <button class="btn btn-primary" id="confirm-new-project">Create Project</button>
            </div>
        </div>
    </div>

    <!-- Reference Image Modal -->
    <div class="modal" id="reference-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-image"></i> Reference Image</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="reference-upload">Upload Reference Image</label>
                    <input type="file" id="reference-upload" class="form-control" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="reference-opacity">Opacity</label>
                    <input type="range" id="reference-opacity" class="form-control" min="10" max="100" value="50">
                </div>
                <div class="form-group">
                    <label for="reference-scale">Scale</label>
                    <input type="range" id="reference-scale" class="form-control" min="10" max="200" value="100">
                </div>
                <div id="reference-preview" style="text-align: center; margin-top: 15px;">
                    <p>No reference image loaded</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-reference">Cancel</button>
                <button class="btn btn-primary" id="confirm-reference">Load Reference</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notification-text">Operation completed successfully!</span>
    </div>

    <script>
        // Canvas setup
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        const gridCanvas = document.getElementById('grid-overlay');
        const gridCtx = gridCanvas.getContext('2d');
        const rulerCanvas = document.getElementById('ruler-overlay');
        const rulerCtx = rulerCanvas.getContext('2d');
        
        // App state
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let currentColor = '#6c5ce7';
        let brushSize = 10;
        let brushOpacity = 1;
        let brushFlow = 1;
        let brushHardness = 1;
        let currentTool = 'normal';
        let zoomLevel = 1;
        let undoStack = [];
        let redoStack = [];
        let rainbowHue = 0;
        let isGridVisible = false;
        let isRulerVisible = false;
        let isFullscreen = false;
        let isEyedropperActive = false;
        let symmetryMode = 'none';
        let blendMode = 'source-over';
        let pressureSensitivity = true;
        let smoothingLevel = 5;
        let layers = [];
        let currentLayerIndex = 0;
        let colorHistory = [];
        let currentProject = {
            name: 'Untitled Project',
            width: 800,
            height: 600,
            backgroundColor: '#ffffff',
            dpi: 300
        };
        let users = JSON.parse(localStorage.getItem('inkflowUsers')) || [];
        let currentUser = null;
        let referenceImage = null;
        let referenceOpacity = 0.5;
        let referenceScale = 1;
        
        // Initialize canvas
        function initCanvas() {
            // Set initial canvas background
            ctx.fillStyle = currentProject.backgroundColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Initialize layers
            initLayers();
            
            // Initialize color history
            initColorHistory();
            
            // Save initial state
            saveState();
            
            // Set up event listeners
            setupEventListeners();
            
            // Update UI
            updateBrushInfo();
            updateProjectInfo();
        }
        
        // Initialize layers
        function initLayers() {
            layers = [{
                name: 'Layer 1',
                visible: true,
                opacity: 1,
                blendMode: 'source-over',
                canvas: document.createElement('canvas'),
                ctx: null
            }];
            
            layers[0].canvas.width = canvas.width;
            layers[0].canvas.height = canvas.height;
            layers[0].ctx = layers[0].canvas.getContext('2d');
            layers[0].ctx.fillStyle = 'transparent';
            layers[0].ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            renderLayers();
            updateLayersPanel();
        }
        
        // Initialize color history
        function initColorHistory() {
            colorHistory = [
                '#ff6b6b', '#4fc3f7', '#8a2be2', '#ffd166', 
                '#06d6a0', '#ff9e6d', '#6c5ce7', '#fd79a8'
            ];
            updateColorHistory();
        }
        
        // Update color history display
        function updateColorHistory() {
            const historyContainer = document.getElementById('color-history');
            historyContainer.innerHTML = '';
            
            colorHistory.forEach(color => {
                const colorEl = document.createElement('div');
                colorEl.className = 'history-color';
                colorEl.style.backgroundColor = color;
                colorEl.title = color;
                colorEl.addEventListener('click', () => {
                    currentColor = color;
                    document.getElementById('color-picker').value = color;
                    updateBrushInfo();
                    updateActivePresetColor();
                });
                historyContainer.appendChild(colorEl);
            });
        }
        
        // Add color to history
        function addColorToHistory(color) {
            // Remove if already exists
            const index = colorHistory.indexOf(color);
            if (index > -1) {
                colorHistory.splice(index, 1);
            }
            
            // Add to beginning
            colorHistory.unshift(color);
            
            // Limit history size
            if (colorHistory.length > 12) {
                colorHistory.pop();
            }
            
            updateColorHistory();
        }
        
        // Render all layers to main canvas
        function renderLayers() {
            // Clear main canvas
            ctx.fillStyle = currentProject.backgroundColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw reference image if exists
            if (referenceImage) {
                ctx.globalAlpha = referenceOpacity;
                ctx.drawImage(
                    referenceImage, 
                    0, 0, 
                    referenceImage.width * referenceScale, 
                    referenceImage.height * referenceScale
                );
                ctx.globalAlpha = 1;
            }
            
            // Draw all visible layers
            layers.forEach(layer => {
                if (layer.visible) {
                    ctx.globalAlpha = layer.opacity;
                    ctx.globalCompositeOperation = layer.blendMode;
                    ctx.drawImage(layer.canvas, 0, 0);
                }
            });
            
            // Reset composite operation
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;
        }
        
        // Update layers panel UI
        function updateLayersPanel() {
            const layersPanel = document.getElementById('layers-panel');
            layersPanel.innerHTML = '';
            
            layers.forEach((layer, index) => {
                const layerItem = document.createElement('div');
                layerItem.className = `layer-item ${index === currentLayerIndex ? 'active' : ''}`;
                layerItem.innerHTML = `
                    <span class="layer-visibility">
                        <i class="fas fa-${layer.visible ? 'eye' : 'eye-slash'}"></i>
                    </span>
                    <span class="layer-name">${layer.name}</span>
                    <div class="layer-actions">
                        <button class="layer-btn move-up-btn" ${index === 0 ? 'disabled' : ''}>
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="layer-btn move-down-btn" ${index === layers.length - 1 ? 'disabled' : ''}>
                            <i class="fas fa-arrow-down"></i>
                        </button>
                    </div>
                `;
                
                // Layer visibility toggle
                layerItem.querySelector('.layer-visibility').addEventListener('click', () => {
                    layer.visible = !layer.visible;
                    renderLayers();
                    updateLayersPanel();
                });
                
                // Layer selection
                layerItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.layer-visibility') && 
                        !e.target.closest('.move-up-btn') && 
                        !e.target.closest('.move-down-btn')) {
                        currentLayerIndex = index;
                        updateLayersPanel();
                        updateBrushInfo();
                    }
                });
                
                // Move layer up
                const moveUpBtn = layerItem.querySelector('.move-up-btn');
                if (moveUpBtn) {
                    moveUpBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (index > 0) {
                            [layers[index], layers[index-1]] = [layers[index-1], layers[index]];
                            if (currentLayerIndex === index) currentLayerIndex--;
                            else if (currentLayerIndex === index-1) currentLayerIndex++;
                            renderLayers();
                            updateLayersPanel();
                        }
                    });
                }
                
                // Move layer down
                const moveDownBtn = layerItem.querySelector('.move-down-btn');
                if (moveDownBtn) {
                    moveDownBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (index < layers.length - 1) {
                            [layers[index], layers[index+1]] = [layers[index+1], layers[index]];
                            if (currentLayerIndex === index) currentLayerIndex++;
                            else if (currentLayerIndex === index+1) currentLayerIndex--;
                            renderLayers();
                            updateLayersPanel();
                        }
                    });
                }
                
                layersPanel.appendChild(layerItem);
            });
        }
        
        // Add a new layer
        function addLayer() {
            const newLayer = {
                name: `Layer ${layers.length + 1}`,
                visible: true,
                opacity: 1,
                blendMode: 'source-over',
                canvas: document.createElement('canvas'),
                ctx: null
            };
            
            newLayer.canvas.width = canvas.width;
            newLayer.canvas.height = canvas.height;
            newLayer.ctx = newLayer.canvas.getContext('2d');
            newLayer.ctx.fillStyle = 'transparent';
            newLayer.ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            layers.push(newLayer);
            currentLayerIndex = layers.length - 1;
            renderLayers();
            updateLayersPanel();
            showNotification('New layer added');
        }
        
        // Delete current layer
        function deleteLayer() {
            if (layers.length <= 1) {
                showNotification('Cannot delete the only layer', 'error');
                return;
            }
            
            layers.splice(currentLayerIndex, 1);
            if (currentLayerIndex >= layers.length) {
                currentLayerIndex = layers.length - 1;
            }
            renderLayers();
            updateLayersPanel();
            showNotification('Layer deleted');
        }
        
        // Merge all visible layers
        function mergeLayers() {
            if (layers.length <= 1) {
                showNotification('Only one layer exists', 'error');
                return;
            }
            
            // Create a new merged layer
            const mergedLayer = {
                name: 'Merged Layer',
                visible: true,
                opacity: 1,
                blendMode: 'source-over',
                canvas: document.createElement('canvas'),
                ctx: null
            };
            
            mergedLayer.canvas.width = canvas.width;
            mergedLayer.canvas.height = canvas.height;
            mergedLayer.ctx = mergedLayer.canvas.getContext('2d');
            
            // Draw all visible layers to the merged layer
            layers.forEach(layer => {
                if (layer.visible) {
                    mergedLayer.ctx.globalAlpha = layer.opacity;
                    mergedLayer.ctx.globalCompositeOperation = layer.blendMode;
                    mergedLayer.ctx.drawImage(layer.canvas, 0, 0);
                }
            });
            
            // Reset and add the merged layer
            layers = [mergedLayer];
            currentLayerIndex = 0;
            renderLayers();
            updateLayersPanel();
            showNotification('Layers merged');
        }
        
        // Set up all event listeners
        function setupEventListeners() {
            // Canvas events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Color picker
            document.getElementById('color-picker').addEventListener('input', (e) => {
                currentColor = e.target.value;
                addColorToHistory(currentColor);
                updateBrushInfo();
                updateActivePresetColor();
            });
            
            // Brush size
            document.getElementById('brush-size').addEventListener('input', (e) => {
                brushSize = parseInt(e.target.value);
                document.getElementById('brush-size-value').textContent = `${brushSize}px`;
                updateBrushInfo();
            });
            
            // Brush opacity
            document.getElementById('brush-opacity').addEventListener('input', (e) => {
                brushOpacity = parseInt(e.target.value) / 100;
                document.getElementById('opacity-value').textContent = `${e.target.value}%`;
            });
            
            // Brush flow
            document.getElementById('brush-flow').addEventListener('input', (e) => {
                brushFlow = parseInt(e.target.value) / 100;
                document.getElementById('brush-flow-value').textContent = `${e.target.value}%`;
            });
            
            // Brush hardness
            document.getElementById('brush-hardness').addEventListener('input', (e) => {
                brushHardness = parseInt(e.target.value) / 100;
                document.getElementById('brush-hardness-value').textContent = `${e.target.value}%`;
            });
            
            // Brush tools
            document.querySelectorAll('.brush-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.brush-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentTool = btn.dataset.type;
                    updateBrushInfo();
                    
                    // Special handling for eyedropper
                    isEyedropperActive = (currentTool === 'eyedropper');
                });
            });
            
            // Preset colors
            document.querySelectorAll('.preset-color').forEach(color => {
                color.addEventListener('click', (e) => {
                    document.querySelectorAll('.preset-color').forEach(c => c.classList.remove('active'));
                    color.classList.add('active');
                    currentColor = color.dataset.color;
                    document.getElementById('color-picker').value = currentColor;
                    addColorToHistory(currentColor);
                    updateBrushInfo();
                });
            });
            
            // Control buttons
            document.getElementById('clear-btn').addEventListener('click', clearCanvas);
            document.getElementById('undo-btn').addEventListener('click', undo);
            document.getElementById('redo-btn').addEventListener('click', redo);
            document.getElementById('download-btn').addEventListener('click', showDownloadModal);
            document.getElementById('save-btn').addEventListener('click', showSaveModal);
            document.getElementById('print-btn').addEventListener('click', printCanvas);
            document.getElementById('new-project-btn').addEventListener('click', showNewProjectModal);
            document.getElementById('grid-toggle').addEventListener('click', toggleGrid);
            document.getElementById('ruler-toggle').addEventListener('click', toggleRuler);
            document.getElementById('toggle-grid-btn').addEventListener('click', toggleGrid);
            document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);
            document.getElementById('reference-image-btn').addEventListener('click', showReferenceModal);
            
            // Layer buttons
            document.getElementById('add-layer-btn').addEventListener('click', addLayer);
            document.getElementById('delete-layer-btn').addEventListener('click', deleteLayer);
            document.getElementById('merge-layers-btn').addEventListener('click', mergeLayers);
            
            // Advanced tools
            document.getElementById('symmetry-mode').addEventListener('change', (e) => {
                symmetryMode = e.target.value;
            });
            
            document.getElementById('blend-mode').addEventListener('change', (e) => {
                blendMode = e.target.value;
                layers[currentLayerIndex].blendMode = blendMode;
                renderLayers();
            });
            
            document.getElementById('pressure-toggle').addEventListener('change', (e) => {
                pressureSensitivity = e.target.checked;
            });
            
            document.getElementById('smoothing-level').addEventListener('input', (e) => {
                smoothingLevel = parseInt(e.target.value);
            });
            
            // Eyedropper tool
            document.getElementById('eyedropper-btn').addEventListener('click', activateEyedropper);
            
            // Zoom controls
            document.getElementById('zoom-in').addEventListener('click', () => zoom(0.1));
            document.getElementById('zoom-out').addEventListener('click', () => zoom(-0.1));
            document.getElementById('reset-view').addEventListener('click', resetView);
            
            // Modal events
            setupModalEvents();
            
            // Auth buttons
            document.getElementById('login-btn').addEventListener('click', () => showModal('login-modal'));
            document.getElementById('register-btn').addEventListener('click', () => showModal('register-modal'));
            
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            // Fullscreen change
            document.addEventListener('fullscreenchange', handleFullscreenChange);
        }
        
        // Set up modal event listeners
        function setupModalEvents() {
            // Download modal
            document.getElementById('confirm-download').addEventListener('click', downloadCanvas);
            document.getElementById('cancel-download').addEventListener('click', () => hideModal('download-modal'));
            
            // Save modal
            document.getElementById('confirm-save').addEventListener('click', saveProject);
            document.getElementById('cancel-save').addEventListener('click', () => hideModal('save-modal'));
            
            // Login modal
            document.getElementById('confirm-login').addEventListener('click', login);
            document.getElementById('cancel-login').addEventListener('click', () => hideModal('login-modal'));
            
            // Register modal
            document.getElementById('confirm-register').addEventListener('click', register);
            document.getElementById('cancel-register').addEventListener('click', () => hideModal('register-modal'));
            
            // New project modal
            document.getElementById('confirm-new-project').addEventListener('click', createNewProject);
            document.getElementById('cancel-new-project').addEventListener('click', () => hideModal('new-project-modal'));
            
            // Reference image modal
            document.getElementById('confirm-reference').addEventListener('click', loadReferenceImage);
            document.getElementById('cancel-reference').addEventListener('click', () => hideModal('reference-modal'));
            document.getElementById('reference-upload').addEventListener('change', previewReferenceImage);
            document.getElementById('reference-opacity').addEventListener('input', (e) => {
                referenceOpacity = parseInt(e.target.value) / 100;
                renderLayers();
            });
            document.getElementById('reference-scale').addEventListener('input', (e) => {
                referenceScale = parseInt(e.target.value) / 100;
                renderLayers();
            });
            
            // Close buttons
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modal = btn.closest('.modal');
                    hideModal(modal.id);
                });
            });
            
            // Close modal when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        hideModal(modal.id);
                    }
                });
            });
        }
        
        // Drawing functions
        function startDrawing(e) {
            if (isEyedropperActive) {
                pickColor(e);
                return;
            }
            
            isDrawing = true;
            [lastX, lastY] = getCoordinates(e);
            
            // Save state before drawing
            saveState();
            
            // Draw initial point for some brushes
            if (currentTool === 'spray' || currentTool === 'glitter') {
                drawPoint(lastX, lastY);
            }
        }
        
        function draw(e) {
            if (!isDrawing || isEyedropperActive) return;
            
            e.preventDefault();
            
            const [x, y] = getCoordinates(e);
            
            // Get the current layer context
            const layerCtx = layers[currentLayerIndex].ctx;
            
            switch(currentTool) {
                case 'normal':
                case 'calligraphy':
                    drawLine(layerCtx, lastX, lastY, x, y);
                    break;
                case 'pixel':
                    drawPixelLine(layerCtx, lastX, lastY, x, y);
                    break;
                case 'rainbow':
                    drawRainbowLine(layerCtx, lastX, lastY, x, y);
                    break;
                case 'fur':
                    drawFurLine(layerCtx, lastX, lastY, x, y);
                    break;
                case 'neon':
                    drawNeonLine(layerCtx, lastX, lastY, x, y);
                    break;
                case 'shading':
                    drawShadingLine(layerCtx, lastX, lastY, x, y);
                    break;
                case 'spray':
                    drawSpray(layerCtx, x, y);
                    break;
                case 'eraser':
                    drawEraserLine(layerCtx, lastX, lastY, x, y);
                    break;
                case 'glitter':
                    drawGlitter(layerCtx, x, y);
                    break;
                case 'watercolor':
                    drawWatercolorLine(layerCtx, lastX, lastY, x, y);
                    break;
                case 'oil':
                    drawOilLine(layerCtx, lastX, lastY, x, y);
                    break;
            }
            
            // Apply symmetry if enabled
            if (symmetryMode !== 'none') {
                applySymmetry(layerCtx, lastX, lastY, x, y);
            }
            
            // Render layers to main canvas
            renderLayers();
            
            [lastX, lastY] = [x, y];
        }
        
        function stopDrawing() {
            isDrawing = false;
        }
        
        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left);
            const y = (e.clientY - rect.top);
            
            return [x, y];
        }
        
        // Brush drawing functions
        function drawLine(ctx, x1, y1, x2, y2) {
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.strokeStyle = currentColor;
            ctx.globalAlpha = brushOpacity * brushFlow;
            ctx.lineWidth = brushSize;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            if (currentTool === 'calligraphy') {
                // Calligraphy brush with varying width
                const gradient = ctx.createLinearGradient(x1, y1, x2, y2);
                gradient.addColorStop(0, currentColor);
                gradient.addColorStop(1, adjustColor(currentColor, -30));
                ctx.strokeStyle = gradient;
                ctx.lineWidth = brushSize * 1.5;
            }
            
            ctx.stroke();
        }
        
        function drawPixelLine(ctx, x1, y1, x2, y2) {
            // Draw pixelated line - snap to grid
            const gridSize = 10; // Size of each pixel grid cell
            const steps = Math.max(Math.abs(x2 - x1), Math.abs(y2 - y1));
            
            for (let i = 0; i <= steps; i++) {
                const t = i / steps;
                let x = x1 + (x2 - x1) * t;
                let y = y1 + (y2 - y1) * t;
                
                // Snap to grid
                x = Math.round(x / gridSize) * gridSize;
                y = Math.round(y / gridSize) * gridSize;
                
                ctx.fillStyle = currentColor;
                ctx.globalAlpha = brushOpacity * brushFlow;
                ctx.fillRect(x - gridSize/2, y - gridSize/2, gridSize, gridSize);
            }
        }
        
        function drawRainbowLine(ctx, x1, y1, x2, y2) {
            // Rainbow brush that cycles through colors
            rainbowHue = (rainbowHue + 2) % 360;
            const rainbowColor = `hsl(${rainbowHue}, 100%, 50%)`;
            
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.strokeStyle = rainbowColor;
            ctx.globalAlpha = brushOpacity * brushFlow;
            ctx.lineWidth = brushSize;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
        }
        
        function drawFurLine(ctx, x1, y1, x2, y2) {
            // Fur brush with multiple hair-like strokes
            const steps = Math.max(Math.abs(x2 - x1), Math.abs(y2 - y1));
            for (let i = 0; i <= steps; i++) {
                const t = i / steps;
                const x = x1 + (x2 - x1) * t;
                const y = y1 + (y2 - y1) * t;
                
                // Draw multiple hair-like strokes
                for (let j = 0; j < 3; j++) {
                    const angle = Math.random() * Math.PI * 2;
                    const length = brushSize * 0.5 + Math.random() * brushSize;
                    const endX = x + Math.cos(angle) * length;
                    const endY = y + Math.sin(angle) * length;
                    
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    ctx.lineTo(endX, endY);
                    ctx.strokeStyle = currentColor;
                    ctx.globalAlpha = brushOpacity * brushFlow * 0.7;
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            }
        }
        
        function drawNeonLine(ctx, x1, y1, x2, y2) {
            // Neon brush with glow effect
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            
            // Outer glow
            ctx.shadowBlur = 15;
            ctx.shadowColor = currentColor;
            ctx.strokeStyle = currentColor;
            ctx.globalAlpha = brushOpacity * brushFlow * 0.7;
            ctx.lineWidth = brushSize + 4;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
            
            // Inner line
            ctx.shadowBlur = 0;
            ctx.strokeStyle = lightenColor(currentColor, 40);
            ctx.globalAlpha = brushOpacity * brushFlow;
            ctx.lineWidth = brushSize;
            ctx.stroke();
        }
        
        function drawShadingLine(ctx, x1, y1, x2, y2) {
            // Shading brush with soft edges
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            
            // Create gradient for soft edges
            const gradient = ctx.createLinearGradient(x1, y1, x2, y2);
            gradient.addColorStop(0, currentColor);
            gradient.addColorStop(0.5, adjustColor(currentColor, -20));
            gradient.addColorStop(1, currentColor);
            
            ctx.strokeStyle = gradient;
            ctx.globalAlpha = brushOpacity * brushFlow * 0.8;
            ctx.lineWidth = brushSize * 1.5;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
        }
        
        function drawSpray(ctx, x, y) {
            // Spray paint effect
            const density = brushSize * 2;
            for (let i = 0; i < density; i++) {
                const angle = Math.random() * Math.PI * 2;
                const radius = Math.random() * brushSize;
                const sprayX = x + Math.cos(angle) * radius;
                const sprayY = y + Math.sin(angle) * radius;
                
                ctx.fillStyle = currentColor;
                ctx.globalAlpha = brushOpacity * brushFlow * 0.3;
                ctx.fillRect(sprayX, sprayY, 1, 1);
            }
        }
        
        function drawEraserLine(ctx, x1, y1, x2, y2) {
            // Eraser tool
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.strokeStyle = 'rgba(0,0,0,0)'; // Transparent
            ctx.globalCompositeOperation = 'destination-out';
            ctx.globalAlpha = brushFlow;
            ctx.lineWidth = brushSize;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
            ctx.globalCompositeOperation = 'source-over'; // Reset
        }
        
        function drawGlitter(ctx, x, y) {
            // Glitter effect with random sparkles
            const density = brushSize;
            for (let i = 0; i < density; i++) {
                const angle = Math.random() * Math.PI * 2;
                const radius = Math.random() * brushSize;
                const glitterX = x + Math.cos(angle) * radius;
                const glitterY = y + Math.sin(angle) * radius;
                
                // Random glitter color (lighter version of current color)
                const glitterColor = lightenColor(currentColor, Math.random() * 50);
                
                ctx.fillStyle = glitterColor;
                ctx.globalAlpha = brushOpacity * brushFlow * 0.8;
                ctx.fillRect(glitterX, glitterY, 2, 2);
            }
        }
        
        function drawWatercolorLine(ctx, x1, y1, x2, y2) {
            // Watercolor brush with soft, blended edges
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            
            // Create a gradient for watercolor effect
            const gradient = ctx.createLinearGradient(x1, y1, x2, y2);
            gradient.addColorStop(0, currentColor);
            gradient.addColorStop(0.3, adjustColor(currentColor, 20));
            gradient.addColorStop(0.7, adjustColor(currentColor, -10));
            gradient.addColorStop(1, currentColor);
            
            ctx.strokeStyle = gradient;
            ctx.globalAlpha = brushOpacity * brushFlow * 0.6;
            ctx.lineWidth = brushSize * 1.2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
            
            // Add some random watercolor spots
            for (let i = 0; i < brushSize / 2; i++) {
                const angle = Math.random() * Math.PI * 2;
                const radius = Math.random() * brushSize * 0.8;
                const spotX = x2 + Math.cos(angle) * radius;
                const spotY = y2 + Math.sin(angle) * radius;
                
                ctx.beginPath();
                ctx.arc(spotX, spotY, brushSize * 0.2, 0, Math.PI * 2);
                ctx.fillStyle = adjustColor(currentColor, Math.random() * 30 - 15);
                ctx.globalAlpha = brushOpacity * brushFlow * 0.3;
                ctx.fill();
            }
        }
        
        function drawOilLine(ctx, x1, y1, x2, y2) {
            // Oil paint brush with thick, textured strokes
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            
            // Thick stroke with texture
            ctx.strokeStyle = currentColor;
            ctx.globalAlpha = brushOpacity * brushFlow;
            ctx.lineWidth = brushSize * 1.5;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
            
            // Add some texture with smaller strokes
            for (let i = 0; i < brushSize / 3; i++) {
                const offsetX = (Math.random() - 0.5) * brushSize * 0.5;
                const offsetY = (Math.random() - 0.5) * brushSize * 0.5;
                
                ctx.beginPath();
                ctx.moveTo(x1 + offsetX, y1 + offsetY);
                ctx.lineTo(x2 + offsetX, y2 + offsetY);
                ctx.strokeStyle = adjustColor(currentColor, Math.random() * 20 - 10);
                ctx.globalAlpha = brushOpacity * brushFlow * 0.5;
                ctx.lineWidth = brushSize * 0.3;
                ctx.stroke();
            }
        }
        
        function drawPoint(x, y) {
            // Draw a single point (used for spray and glitter on mousedown)
            const layerCtx = layers[currentLayerIndex].ctx;
            
            if (currentTool === 'spray') {
                drawSpray(layerCtx, x, y);
            } else if (currentTool === 'glitter') {
                drawGlitter(layerCtx, x, y);
            }
            
            renderLayers();
        }
        
        // Symmetry functions
        function applySymmetry(ctx, x1, y1, x2, y2) {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            if (symmetryMode === 'vertical') {
                // Vertical symmetry
                const mirroredX1 = 2 * centerX - x1;
                const mirroredX2 = 2 * centerX - x2;
                
                ctx.beginPath();
                ctx.moveTo(mirroredX1, y1);
                ctx.lineTo(mirroredX2, y2);
                ctx.stroke();
            } else if (symmetryMode === 'horizontal') {
                // Horizontal symmetry
                const mirroredY1 = 2 * centerY - y1;
                const mirroredY2 = 2 * centerY - y2;
                
                ctx.beginPath();
                ctx.moveTo(x1, mirroredY1);
                ctx.lineTo(x2, mirroredY2);
                ctx.stroke();
            } else if (symmetryMode === 'radial') {
                // Radial symmetry (4-way)
                const mirroredX1 = 2 * centerX - x1;
                const mirroredX2 = 2 * centerX - x2;
                const mirroredY1 = 2 * centerY - y1;
                const mirroredY2 = 2 * centerY - y2;
                
                // Top-right quadrant
                ctx.beginPath();
                ctx.moveTo(mirroredX1, y1);
                ctx.lineTo(mirroredX2, y2);
                ctx.stroke();
                
                // Bottom-left quadrant
                ctx.beginPath();
                ctx.moveTo(x1, mirroredY1);
                ctx.lineTo(x2, mirroredY2);
                ctx.stroke();
                
                // Bottom-right quadrant
                ctx.beginPath();
                ctx.moveTo(mirroredX1, mirroredY1);
                ctx.lineTo(mirroredX2, mirroredY2);
                ctx.stroke();
            }
        }
        
        // Eyedropper functions
        function activateEyedropper() {
            isEyedropperActive = true;
            canvas.style.cursor = 'crosshair';
            showNotification('Click on the canvas to pick a color');
        }
        
        function pickColor(e) {
            const [x, y] = getCoordinates(e);
            const pixel = ctx.getImageData(x, y, 1, 1).data;
            const color = `rgb(${pixel[0]}, ${pixel[1]}, ${pixel[2]})`;
            
            currentColor = rgbToHex(pixel[0], pixel[1], pixel[2]);
            document.getElementById('color-picker').value = currentColor;
            addColorToHistory(currentColor);
            updateBrushInfo();
            updateActivePresetColor();
            
            isEyedropperActive = false;
            canvas.style.cursor = 'crosshair';
            showNotification(`Color picked: ${currentColor}`);
        }
        
        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        
        // Grid functions
        function toggleGrid() {
            isGridVisible = !isGridVisible;
            const gridOverlay = document.getElementById('grid-overlay');
            
            if (isGridVisible) {
                gridOverlay.style.display = 'block';
                drawGrid();
                showNotification('Grid enabled');
            } else {
                gridOverlay.style.display = 'none';
                showNotification('Grid disabled');
            }
        }
        
        function drawGrid() {
            const gridSize = 10;
            const width = gridCanvas.width;
            const height = gridCanvas.height;
            
            gridCtx.clearRect(0, 0, width, height);
            gridCtx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
            gridCtx.lineWidth = 1;
            
            // Draw vertical lines
            for (let x = 0; x <= width; x += gridSize) {
                gridCtx.beginPath();
                gridCtx.moveTo(x, 0);
                gridCtx.lineTo(x, height);
                gridCtx.stroke();
            }
            
            // Draw horizontal lines
            for (let y = 0; y <= height; y += gridSize) {
                gridCtx.beginPath();
                gridCtx.moveTo(0, y);
                gridCtx.lineTo(width, y);
                gridCtx.stroke();
            }
        }
        
        // Ruler functions
        function toggleRuler() {
            isRulerVisible = !isRulerVisible;
            const rulerOverlay = document.getElementById('ruler-overlay');
            
            if (isRulerVisible) {
                rulerOverlay.style.display = 'block';
                drawRuler();
                showNotification('Ruler enabled');
            } else {
                rulerOverlay.style.display = 'none';
                showNotification('Ruler disabled');
            }
        }
        
        function drawRuler() {
            const width = rulerCanvas.width;
            const height = rulerCanvas.height;
            
            rulerCtx.clearRect(0, 0, width, height);
            rulerCtx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
            rulerCtx.lineWidth = 1;
            rulerCtx.font = '10px Arial';
            rulerCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            
            // Draw horizontal ruler
            for (let x = 0; x <= width; x += 50) {
                rulerCtx.beginPath();
                rulerCtx.moveTo(x, 0);
                rulerCtx.lineTo(x, 15);
                rulerCtx.stroke();
                
                if (x % 100 === 0) {
                    rulerCtx.fillText(x.toString(), x - 10, 30);
                }
            }
            
            // Draw vertical ruler
            for (let y = 0; y <= height; y += 50) {
                rulerCtx.beginPath();
                rulerCtx.moveTo(0, y);
                rulerCtx.lineTo(15, y);
                rulerCtx.stroke();
                
                if (y % 100 === 0 && y > 0) {
                    rulerCtx.save();
                    rulerCtx.translate(30, y + 5);
                    rulerCtx.rotate(-Math.PI/2);
                    rulerCtx.fillText(y.toString(), 0, 0);
                    rulerCtx.restore();
                }
            }
        }
        
        // Fullscreen functions
        function toggleFullscreen() {
            if (!isFullscreen) {
                const canvasContainer = document.querySelector('.canvas-container');
                if (canvasContainer.requestFullscreen) {
                    canvasContainer.requestFullscreen();
                } else if (canvasContainer.webkitRequestFullscreen) {
                    canvasContainer.webkitRequestFullscreen();
                } else if (canvasContainer.msRequestFullscreen) {
                    canvasContainer.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }
        
        function handleFullscreenChange() {
            isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
        }
        
        // Reference image functions
        function showReferenceModal() {
            showModal('reference-modal');
        }
        
        function previewReferenceImage(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const preview = document.getElementById('reference-preview');
                preview.innerHTML = `<img src="${event.target.result}" style="max-width: 100%; max-height: 200px;">`;
            };
            reader.readAsDataURL(file);
        }
        
        function loadReferenceImage() {
            const fileInput = document.getElementById('reference-upload');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Please select an image', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                referenceImage = new Image();
                referenceImage.onload = function() {
                    renderLayers();
                    hideModal('reference-modal');
                    showNotification('Reference image loaded');
                };
                referenceImage.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // Print function
        function printCanvas() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Print Artwork</title>
                        <style>
                            body { text-align: center; margin: 20px; }
                            img { max-width: 100%; height: auto; }
                        </style>
                    </head>
                    <body>
                        <h1>${currentProject.name}</h1>
                        <img src="${canvas.toDataURL('image/png')}" alt="Artwork">
                        <p>Printed from InkFlow Studio</p>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        // Color utility functions
        function adjustColor(color, amount) {
            // Adjust color brightness
            let usePound = false;
            if (color[0] === "#") {
                color = color.slice(1);
                usePound = true;
            }
            
            const num = parseInt(color, 16);
            let r = (num >> 16) + amount;
            if (r > 255) r = 255;
            else if (r < 0) r = 0;
            
            let b = ((num >> 8) & 0x00FF) + amount;
            if (b > 255) b = 255;
            else if (b < 0) b = 0;
            
            let g = (num & 0x0000FF) + amount;
            if (g > 255) g = 255;
            else if (g < 0) g = 0;
            
            return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16).padStart(6, '0');
        }
        
        function lightenColor(color, percent) {
            // Lighten a color by a percentage
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            
            return "#" + (
                0x1000000 +
                (R < 255 ? (R < 1 ? 0 : R) : 255) * 0x10000 +
                (G < 255 ? (G < 1 ? 0 : G) : 255) * 0x100 +
                (B < 255 ? (B < 1 ? 0 : B) : 255)
            ).toString(16).slice(1);
        }
        
        // Canvas controls
        function clearCanvas() {
            if (confirm('Are you sure you want to clear the canvas?')) {
                layers.forEach(layer => {
                    layer.ctx.clearRect(0, 0, canvas.width, canvas.height);
                });
                renderLayers();
                saveState();
                showNotification('Canvas cleared');
            }
        }
        
        function saveState() {
            // Save the state of all layers
            const state = layers.map(layer => ({
                name: layer.name,
                visible: layer.visible,
                data: layer.canvas.toDataURL()
            }));
            undoStack.push(state);
            if (undoStack.length > 50) {
                undoStack.shift();
            }
            redoStack = [];
        }
        
        function undo() {
            if (undoStack.length > 1) {
                redoStack.push(undoStack.pop());
                const state = undoStack[undoStack.length - 1];
                
                // Restore all layers from state
                state.forEach((layerState, index) => {
                    if (index < layers.length) {
                        const img = new Image();
                        img.onload = function() {
                            layers[index].ctx.clearRect(0, 0, canvas.width, canvas.height);
                            layers[index].ctx.drawImage(img, 0, 0);
                            if (index === state.length - 1) {
                                renderLayers();
                            }
                        };
                        img.src = layerState.data;
                    }
                });
                
                showNotification('Undo completed');
            }
        }
        
        function redo() {
            if (redoStack.length > 0) {
                const state = redoStack.pop();
                undoStack.push(state);
                
                // Restore all layers from state
                state.forEach((layerState, index) => {
                    if (index < layers.length) {
                        const img = new Image();
                        img.onload = function() {
                            layers[index].ctx.clearRect(0, 0, canvas.width, canvas.height);
                            layers[index].ctx.drawImage(img, 0, 0);
                            if (index === state.length - 1) {
                                renderLayers();
                            }
                        };
                        img.src = layerState.data;
                    }
                });
                
                showNotification('Redo completed');
            }
        }
        
        // Zoom and pan functions
        function zoom(delta) {
            zoomLevel += delta;
            zoomLevel = Math.max(0.1, Math.min(5, zoomLevel));
            updateCanvasTransform();
            document.getElementById('zoom-display').textContent = `${Math.round(zoomLevel * 100)}%`;
        }
        
        function resetView() {
            zoomLevel = 1;
            updateCanvasTransform();
            document.getElementById('zoom-display').textContent = '100%';
        }
        
        function updateCanvasTransform() {
            canvas.style.transform = `scale(${zoomLevel})`;
            gridCanvas.style.transform = `scale(${zoomLevel})`;
            rulerCanvas.style.transform = `scale(${zoomLevel})`;
        }
        
        // Project functions
        function showNewProjectModal() {
            document.getElementById('new-project-name').value = 'New Project';
            document.getElementById('canvas-width').value = '800';
            document.getElementById('canvas-height').value = '600';
            document.getElementById('canvas-background').value = '#ffffff';
            document.getElementById('canvas-dpi').value = '300';
            showModal('new-project-modal');
        }
        
        function createNewProject() {
            const name = document.getElementById('new-project-name').value;
            const width = parseInt(document.getElementById('canvas-width').value);
            const height = parseInt(document.getElementById('canvas-height').value);
            const backgroundColor = document.getElementById('canvas-background').value;
            const dpi = parseInt(document.getElementById('canvas-dpi').value);
            
            if (!name) {
                showNotification('Please enter a project name', 'error');
                return;
            }
            
            if (width < 100 || width > 4000 || height < 100 || height > 4000) {
                showNotification('Canvas dimensions must be between 100 and 4000 pixels', 'error');
                return;
            }
            
            // Update project settings
            currentProject = {
                name: name,
                width: width,
                height: height,
                backgroundColor: backgroundColor,
                dpi: dpi
            };
            
            // Resize canvases
            canvas.width = width;
            canvas.height = height;
            gridCanvas.width = width;
            gridCanvas.height = height;
            rulerCanvas.width = width;
            rulerCanvas.height = height;
            
            // Reset layers
            initLayers();
            
            // Update UI
            updateProjectInfo();
            
            hideModal('new-project-modal');
            showNotification('New project created');
        }
        
        function updateProjectInfo() {
            document.getElementById('project-title').textContent = currentProject.name;
        }
        
        // Authentication functions
        function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showNotification('Please enter both email and password', 'error');
                return;
            }
            
            // Check if user exists
            const user = users.find(u => u.email === email && u.password === password);
            
            if (user) {
                currentUser = user;
                hideModal('login-modal');
                updateUserInterface();
                showNotification(`Welcome back, ${user.username}!`);
            } else {
                showNotification('Invalid email or password', 'error');
            }
        }
        
        function register() {
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirm = document.getElementById('register-confirm').value;
            
            if (!username || !email || !password || !confirm) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            if (password !== confirm) {
                showNotification('Passwords do not match', 'error');
                return;
            }
            
            // Check if user already exists
            if (users.find(u => u.email === email)) {
                showNotification('User with this email already exists', 'error');
                return;
            }
            
            // Create new user
            const newUser = {
                username: username,
                email: email,
                password: password
            };
            
            users.push(newUser);
            localStorage.setItem('inkflowUsers', JSON.stringify(users));
            
            currentUser = newUser;
            hideModal('register-modal');
            updateUserInterface();
            showNotification('Account created successfully!');
        }
        
        function updateUserInterface() {
            if (currentUser) {
                document.getElementById('login-btn').textContent = currentUser.username;
                document.getElementById('register-btn').style.display = 'none';
            } else {
                document.getElementById('login-btn').textContent = 'Login';
                document.getElementById('register-btn').style.display = 'block';
            }
        }
        
        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function showDownloadModal() {
            showModal('download-modal');
        }
        
        function downloadCanvas() {
            const filename = document.getElementById('filename').value || 'inkflow-artwork';
            const format = document.getElementById('file-format').value;
            const quality = parseFloat(document.getElementById('export-quality').value);
            const scale = parseFloat(document.getElementById('export-scale').value);
            
            // Create a temporary canvas for export
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = canvas.width * scale;
            exportCanvas.height = canvas.height * scale;
            const exportCtx = exportCanvas.getContext('2d');
            
            // Draw the main canvas to the export canvas with scaling
            exportCtx.drawImage(canvas, 0, 0, exportCanvas.width, exportCanvas.height);
            
            const link = document.createElement('a');
            link.download = `${filename}.${format}`;
            link.href = exportCanvas.toDataURL(`image/${format}`, quality);
            link.click();
            
            hideModal('download-modal');
            showNotification('Artwork downloaded successfully!');
        }
        
        function showSaveModal() {
            if (!currentUser) {
                showNotification('Please log in to save projects', 'error');
                showModal('login-modal');
                return;
            }
            
            showModal('save-modal');
        }
        
        function saveProject() {
            const projectName = document.getElementById('project-name').value;
            
            // In a real app, you would save to a database or local storage
            // For now, we'll just show a notification
            hideModal('save-modal');
            showNotification(`Project "${projectName}" saved successfully!`);
        }
        
        // UI update functions
        function updateBrushInfo() {
            document.getElementById('current-brush').textContent = currentTool.charAt(0).toUpperCase() + currentTool.slice(1);
            document.getElementById('current-size').textContent = `${brushSize}px`;
            document.getElementById('current-color').textContent = currentColor;
            document.getElementById('current-layer').textContent = layers[currentLayerIndex].name;
        }
        
        function updateActivePresetColor() {
            document.querySelectorAll('.preset-color').forEach(color => {
                if (color.dataset.color === currentColor) {
                    color.classList.add('active');
                } else {
                    color.classList.remove('active');
                }
            });
        }
        
        // Notification system
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notification-text');
            
            text.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type);
            notification.style.display = 'flex';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Keyboard shortcuts
        function handleKeyboardShortcuts(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'z':
                        e.preventDefault();
                        undo();
                        break;
                    case 'y':
                        e.preventDefault();
                        redo();
                        break;
                    case 's':
                        e.preventDefault();
                        showSaveModal();
                        break;
                    case 'd':
                        e.preventDefault();
                        showDownloadModal();
                        break;
                    case 'n':
                        e.preventDefault();
                        showNewProjectModal();
                        break;
                    case 'g':
                        e.preventDefault();
                        toggleGrid();
                        break;
                    case 'e':
                        e.preventDefault();
                        activateEyedropper();
                        break;
                }
            }
            
            if (e.key === 'Delete' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                clearCanvas();
            }
        }
        
        // Initialize the app when the page loads
        window.addEventListener('load', initCanvas);
    </script>
</body>
</html>
